pr: none
trigger: none

variables:
  - name: subscription_name
    value: AzureRM SvcConnection JMB-DPL-SDLZ-TST

stages:
  - stage: Build
    jobs:
    # Build bicep main files
    steps:
      - template: bicep-build.yml
        parameters:
          subscription_name: ${{ variables.subscription_name }}
          bicep_dir: $(Build.SourcesDirectory)/infra/main.bicep
      
      - task: ps-rule-assert@2
        displayName: Analyze Azure template files
        inputs:
          inputType: repository
          modules: 'PSRule.Rules.Azure'


  - stage: Deploy
    dependsOn:
      - What_if
    variables:
      - group: "Terraform Vars DEV"
    jobs:
    # Deploy bicep main files
      - template: bicep-deploy.yml
        parameters:
          template_file: '$(Pipeline.Workspace)/infra/main.bicep'
          job_name: 'DeployInfra'
          deployment_scope: 'sub'
          deploy_env_name: 'tst'
          subscription: ${{ variables.subscription_name }}
          template_parameters: '--parameters environment=tst'