parameters:
  - name: location
    type: string
    default: westeurope
  - name: azureSubscription
    type: string
  - name: azure_environment
    type: string

steps:
  - task: AzurePowerShell@5
    displayName: 'Publish Bicep file'
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      ScriptType: 'InlineScript'
      azurePowerShellVersion: LatestVersion
      Inline: |
        # Set credentials
        $SecureStringPwd = ConvertTo-SecureString '$(contributor-service-principal-secret)' -AsPlainText -Force
        $pscredential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList `
         "`$(contributor-app-registration-id)", $SecureStringPwd

        # Connect to Azure
        Connect-AzAccount -ServicePrincipal -Subscription "$(subscription-id)" -Credential $pscredential -Tenant "`$(tenant-id)"

        # Deploy build
        New-AzSubscriptionDeployment -Location "westeurope" `
        -TemplateFile infra/main.bicep" `
        -TemplateParameterFile infra/params.json"